```{r, echo=FALSE}
knitr::opts_chunk$set(cache=TRUE, error=FALSE, warning=FALSE, message=FALSE)
```

```{r loading}
library(scRNAseq)
sce.grun <- GrunPancreasData()
```

```{r gene-annotation}
# Converting back to Ensembl identifiers.
library(org.Hs.eg.db)
gene.symb <- sub("__chr.*$", "", rownames(sce.grun))
gene.ids <- mapIds(org.Hs.eg.db, keys=gene.symb, 
    keytype="SYMBOL", column="ENSEMBL")

# Removing duplicated genes or genes without Ensembl IDs.
keep <- !is.na(gene.ids) & !duplicated(gene.ids)
sce.grun <- sce.grun[keep,]
rownames(sce.grun) <- gene.ids[keep]
```

```{r quality-control}
library(scater)
QC <- perCellQCMetrics(sce.grun)
filter <- quickCellQC(QC, percent_subsets="altexps_ERCC_percent", nmads=3)
sce.grun <- sce.grun[,!filter$discard]
```

```{r normalization}
library(scran)
set.seed(1000) # for irlba. 
clusters <- quickCluster(sce.grun)
sce.grun <- computeSumFactors(sce.grun, min.mean=0.1, clusters=clusters)
sce.grun <- logNormCounts(sce.grun)
```

```{r variance-modelling}
# Blocking on a combined plate and donor factor.
block <- paste0(sce.grun$sample, "_", sce.grun$donor)
dec.grun <- modelGeneVarWithSpikes(sce.grun, spikes="ERCC", block=block)
```
